<!DOCTYPE html>
<html>
<head>
    <title>üéõÔ∏è Unified TEP Control Panel</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' http://127.0.0.1:* http://localhost:*; script-src 'self' 'unsafe-inline' 'unsafe-eval'; connect-src 'self' http://127.0.0.1:* http://localhost:*;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- üîß Cache Control: Force browser to reload JavaScript/CSS after updates -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 100%; margin: 0 auto; padding: 0 20px; box-sizing: border-box; }
        .header { background: linear-gradient(135deg, #2196F3 0%, #21CBF3 100%);
                 color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
        .section { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;
                  box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .controls-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .control-card { padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #f8f9fa; }

        .btn { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: #2196F3; color: white; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-warning { background: #ff9800; color: white; }
        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .status-card { padding: 15px; border-radius: 8px; text-align: center; }
        .status-running { background: #e8f5e8; border: 2px solid #4CAF50; }
        .status-stopped { background: #ffeaea; border: 2px solid #f44336; }
        .xmv-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            max-height: 500px;
            overflow-y: auto;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        .xmv-control {
            padding: 12px;
            border: 1px solid #007bff;
            border-radius: 6px;
            background-color: white;
            font-size: 13px;
        }
        .xmv-control label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #007bff;
        }
        .idv-checkbox-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(3, auto);
            gap: 15px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #2c3e50;
            box-sizing: border-box;
            width: 100%;
        }
        .idv-knob-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            border: 2px solid #34495e;
            border-radius: 6px;
            background: linear-gradient(145deg, #34495e, #2c3e50);
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            font-size: 9px;
        }
        .idv-knob-label {
            text-align: center;
            font-weight: bold;
            color: #ecf0f1;
            margin-bottom: 5px;
            font-size: 8px;
            line-height: 1.1;
            min-height: 28px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .idv-knob {
            position: relative;
            width: 70px;
            height: 70px;
            margin: 5px 0;
            cursor: pointer;
            user-select: none;
        }
        .idv-knob-bg {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #4a5f7f, #2c3e50);
            border: 3px solid #1a252f;
            box-shadow:
                inset 0 2px 4px rgba(0,0,0,0.5),
                0 2px 8px rgba(0,0,0,0.3);
        }
        .idv-knob-indicator {
            position: absolute;
            top: 10%;
            left: 50%;
            width: 4px;
            height: 35%;
            background: linear-gradient(to bottom, #e74c3c, #c0392b);
            transform-origin: bottom center;
            border-radius: 2px;
            box-shadow: 0 0 4px rgba(231, 76, 60, 0.8);
        }
        .idv-knob-value {
            text-align: center;
            font-weight: bold;
            color: #3498db;
            margin-top: 8px;
            font-size: 16px;
            text-shadow: 0 0 4px rgba(52, 152, 219, 0.5);
        }
        .idv-knob-arc {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }
        .idv-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
            max-height: 600px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .idv-control {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: white;
            font-size: 12px;
        }
        .slider { width: 100%; margin: 8px 0; }
        .data-flow { background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .timing-info { background: #1976d2; color: white; padding: 10px; border-radius: 5px; font-size: 14px; font-weight: bold; }
        #status { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .btn-active { background: #4CAF50 !important; color: #fff !important; }

        .correct-badge { background: #4CAF50; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; }
        .live-badge { display:inline-block; padding:4px 10px; border-radius:12px; font-weight:700; font-size:12px; margin-left:8px; }
        .live-ok { background:#4CAF50; color:#fff; }
        .live-bad { background:#f44336; color:#fff; }

        /* Tab Styles */
        .tab-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0 5px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.3); }
        .tab-btn.active { background: rgba(255,255,255,0.4); box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Documentation Styles */
        .docs-section {
            background: #f8f9fa;
            padding: 25px;
            margin: 20px 0;
            border-radius: 15px;
            border-left: 5px solid #17a2b8;
        }
        .docs-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .docs-table th, .docs-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        .docs-table th {
            background: #4facfe;
            color: white;
            font-weight: 600;
        }
        .docs-table tr:hover { background: #f8f9fa; }
        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin: 10px 0;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéõÔ∏è Unified TEP Control Panel</h1>
            <p>Single interface for Dynamic TEP Simulation + FaultExplainer Integration
               <span id="live-connection" class="live-badge live-bad">Live: Disconnected</span>
               <span id="live-count" class="live-badge">Received: 0</span>
            </p>
            <div class="timing-info">
                ‚è±Ô∏è <strong>Timing:</strong> TEP Simulation (3min) ‚Üí Anomaly Detection (6min) ‚Üí LLM Diagnosis (12min)
            </div>

            <!-- Navigation Tabs -->
            <div style="margin-top: 20px;">
                <button class="tab-btn active" onclick="showTab('control')">üéõÔ∏è Control Panel</button>
                <button class="tab-btn" onclick="showTab('monitor')">üìä Monitor</button>
                <button class="tab-btn" onclick="showTab('docs')">üìö Knowledge Base</button>
            </div>
        </div>

        <div id="status"></div>

        <!-- Status Display for Form Actions -->
        <div id="form-status" style="display: none; padding: 15px; margin: 10px; border-radius: 8px; font-weight: bold;"></div>

        <!-- Tab Content: Control Panel -->
        <div id="control-tab" class="tab-content active">
            <!-- JavaScript Status -->
            <div id="js-status-indicator" style="background: #e3f2fd; padding: 8px; margin: 10px; border-radius: 5px; font-size: 12px; text-align: center;">
                üîß JavaScript Status: <span id="js-status" style="color: orange;">Loading...</span>
            </div>

        <!-- EMERGENCY FALLBACK: Form-based controls (REMOVED) -->
        <!--
        <div style="background: #ff6b6b; color: white; padding: 15px; margin: 10px; border-radius: 8px;">
            <h3>ÔøΩ EMERGENCY FALLBACK CONTROLS</h3>
            <p>JavaScript buttons not working - using form-based controls</p>
            <div style="margin: 10px 0;">
                <button onclick="simpleTest()" style="background: #ff9800; color: white; padding: 10px 20px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer;">
                    üß™ SIMPLE TEST BUTTON
                </button>
                <button onclick="testFunction()" style="background: #9c27b0; color: white; padding: 10px 20px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin-left: 10px;">
                    üîß TEST FUNCTION
                </button>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <form method="POST" action="/api/tep/start" style="display: inline;">
                    <button type="submit" style="padding: 10px; background: #28a745; color: white; border: none; border-radius: 5px;">‚ñ∂Ô∏è Start TEP</button>
                </form>
                <form method="POST" action="/api/faultexplainer/backend/start" style="display: inline;">
                    <button type="submit" style="padding: 10px; background: #007bff; color: white; border: none; border-radius: 5px;">‚ñ∂Ô∏è Start Backend</button>
                </form>
                <form method="POST" action="/api/faultexplainer/frontend/start" style="display: inline;">
                    <button type="submit" style="padding: 10px; background: #6f42c1; color: white; border: none; border-radius: 5px;">‚ñ∂Ô∏è Start Frontend</button>
                </form>
                <form method="POST" action="/api/bridge/start" style="display: inline;">
                    <button type="submit" style="padding: 10px; background: #fd7e14; color: white; border: none; border-radius: 5px;">‚ñ∂Ô∏è Start Bridge</button>
                </form>
            </div>
        </div>
        -->

        <!-- System Status -->
        <div class="section">
            <h3>üìä System Status</h3>
            <div class="status-grid" id="status-grid">
                <div class="status-card status-stopped">
                    <h4>üè≠ TEP Simulation</h4>
                    <p id="tep-status">Stopped</p>
                    <p>Step: <span id="tep-step">0</span></p>
                </div>
                <div class="status-card status-stopped">
                    <h4>üîç Fault Analysis Backend</h4>
                    <p id="backend-status">Stopped</p>
                </div>
                <div class="status-card status-stopped">
                    <h4>üñ•Ô∏è Fault Analysis Frontend</h4>
                    <p id="frontend-status">Stopped</p>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 10px; padding: 0 20px;">
                <p>Speed: <span id="speed-mode">Real (180s)</span></p>
                <p>Preset: <span id="preset-mode">None</span></p>
                <div>
                    <h4 style="display: inline; margin-right: 20px;">üìà Data Points</h4>
                    <span>Raw: <span id="raw-count">0</span> | </span>
                    <span>Anomaly Detection: <span id="pca-count">0</span> | </span>
                    <span>LLM: <span id="llm-count">0</span></span>
                </div>
            </div>
        </div>

        <!-- Main Controls -->
        <div class="section">
            <h3>üéõÔ∏è Main Controls</h3>


            <div class="controls-grid">
                <div class="control-card">
                    <h4>üè≠ TEP Dynamic Simulation</h4>
                    <p>Real tep2py physics simulation with 3-minute intervals</p>
                    <button class="btn btn-success" onclick="startTEP()">‚ñ∂Ô∏è Start TEP Simulation</button>
                    <button class="btn btn-danger" onclick="stopTEP()">‚èπÔ∏è Stop TEP Simulation</button>
                    <button class="btn btn-warning" onclick="restartTEP()">‚ü≥ Restart TEP</button>
                    <button class="btn btn-info" onclick="systemHealthCheck()" style="margin-top: 8px;">üîç System Health Check</button>
                    <button class="btn btn-success" onclick="ultraStart()" style="margin-top: 8px; font-weight: bold; background: linear-gradient(45deg, #ff6b6b, #4ecdc4); border: none; color: white;">üöÄ ULTRA START (50x)</button>
                    <div style="margin-top: 10px; padding: 8px; background: #f0f8ff; border-radius: 5px; border-left: 4px solid #2196f3;">
                        <h5 style="margin: 0 0 5px 0; color: #1976d2;">üéØ Anomaly Detection Stabilization</h5>
                        <div id="training-progress" style="display: none; margin: 5px 0; padding: 5px; background: #e8f5e8; border-radius: 3px;">
                            <div style="font-weight: bold; color: #2e7d32; margin-bottom: 5px;">üìä Collecting Stable Data...</div>
                            <div style="background: #ddd; border-radius: 10px; height: 8px; overflow: hidden;">
                                <div id="progress-bar" style="background: linear-gradient(90deg, #4caf50, #2e7d32); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                        <button class="btn btn-info" onclick="checkPCAStatus()" style="margin-right: 5px;">üìä Check Status</button>
                        <button class="btn btn-success" onclick="stabilizePCA()">üéØ Stabilize System</button>
                        <p style="font-size: 11px; color: #666; margin: 5px 0 0 0;">
                            Enhances anomaly detection with current system baseline
                        </p>
                    </div>
                        <div style="margin-top:10px;">
                            <span>Simulation Speed:</span>
                            <div style="margin-top:8px">
                                <label>Speed Factor: <span id="speed-factor">1.0</span>x (Normal)</label>
                                <input type="range" min="0.1" max="50" step="0.1" value="1.0" class="slider" id="speed-factor-slider" onchange="setSpeedFactor(this.value)">
                                <div style="font-size:12px; color:#666; margin-top:4px;">
                                    0.1x = 10x slower | 1.0x = Normal | 10x = 10x faster | 50x = Ultra-fast
                                </div>
                                <div style="font-size:11px; color:#4caf50; margin-top:6px; padding:4px; background:#e8f5e8; border-radius:4px;">
                                    ‚úÖ <strong>Speed Control Active:</strong> Affects actual Fortran physics simulation speed via DELTAT scaling
                                </div>
                            </div>
                        </div>
                </div>

                <div class="control-card">
                    <h4>üîç Fault Analysis Backend</h4>
                    <p>Analysis engine with correct threshold (0.01)</p>
                    <button class="btn btn-success" onclick="startBackend()">‚ñ∂Ô∏è Start Backend</button>
                    <button class="btn btn-danger" onclick="stopBackend()">‚èπÔ∏è Stop Backend</button>
                    <p style="font-size: 12px; color: #666;">Port: 8000</p>
                        <div style="margin-top:8px">
                            <label>LLM min interval: <span id="llm-interval-label">60</span>s</label>
                            <input type="range" min="30" max="180" step="10" value="60" class="slider" id="llm-interval-slider" onchange="setLLMInterval(this.value)">
                        </div>
                        <div style="margin-top:6px">
                            <button id="btn-reload-baseline" class="btn" onclick="reloadBaseline()">‚ü≥ Reload Baseline</button>
                            <button id="btn-stability-defaults" class="btn" onclick="applyStabilityDefaults()">‚úî Apply Stability Defaults</button>
                            
                            <button id="btn-rag-reindex" class="btn" onclick="ragReindex()">‚ü≥ Reindex Knowledge (RAG)</button>
                        </div>
                </div>

                <div class="control-card">
                    <h4>üñ•Ô∏è Fault Analysis Frontend</h4>
                    <p>React interface for visualization and control</p>
                    <button class="btn btn-success" onclick="startFrontend()">‚ñ∂Ô∏è Start Frontend</button>
                    <button class="btn btn-danger" onclick="stopFrontend()">‚èπÔ∏è Stop Frontend</button>
                    <p style="font-size: 12px; color: #666;">Port: 5173</p>
                    <div style="margin-top:6px">
                        <button id="btn-bridge-start" class="btn" onclick="startBridge()">‚ñ∂Ô∏è Start Bridge</button>
                        <button class="btn btn-danger" onclick="stopBridge()">‚èπÔ∏è Stop Bridge</button>
                        <p style="font-size: 12px; color: #666;">Monitors: data/live_tep_data.csv</p>
                    </div>
                </div>
            </div>

            <div class="controls-grid">
                <div class="control-card">
                    <h4>üõë Emergency Stop</h4>
                    <p>Stop all running processes</p>
                    <button class="btn btn-danger" onclick="stopAll()">üõë Stop Everything</button>
                </div>

                <div class="control-card">
                    <h4>üìä Data Analysis</h4>
                    <p>Download and review analysis history</p>
                    <div style="display:flex; gap:8px; align-items:center; margin-top:6px; flex-wrap:wrap;">
                        <label style="font-size:12px; color:#666">Show last</label>
                        <select id="history-limit" class="btn">
                            <option>5</option>
                            <option>10</option>
                            <option>20</option>
                        </select>
                        <button class="btn" onclick="showAnalysisHistory()">üîÑ Load History</button>
                        <button class="btn" onclick="openAnalysisFolder()" style="background:#28a745;">üìÅ Browse RCA Files</button>
                        <!-- üîß NEW: Auto-refresh toggle -->
                        <label style="display:flex; align-items:center; gap:4px; font-size:12px; color:#666; cursor:pointer;">
                            <input type="checkbox" id="auto-refresh-checkbox" onchange="toggleAutoRefresh(this.checked)" style="cursor:pointer;">
                            Auto-refresh (30s)
                        </label>
                    </div>
                    <p style="margin-top:6px; font-size:12px; color:#666">RCA logs auto-saved at backend/diagnostics/analysis_history/YYYY-MM-DD.md</p>
                    <!-- Container to display loaded analysis history -->
                    <div id="data-flow" style="margin-top:12px; max-height:400px; overflow:auto;">
                    </div>
                </div>

                <div class="control-card">
                    <h4>üì∏ System Snapshot</h4>
                    <p>Save and restore complete TEP system states</p>
                    <div style="display:flex; gap:8px; margin-top:10px;">
                        <button class="btn btn-primary" onclick="saveSystemSnapshot()">üíæ Save Snapshot</button>
                        <button class="btn" onclick="loadSnapshotList()">üîÑ Refresh List</button>
                    </div>
                    <div id="snapshot-list-container" style="margin-top:12px; max-height:400px; overflow:auto;">
                        <p style="color:#888;">Click "Refresh List" to view saved snapshots</p>
                    </div>
                </div>

                <div class="control-card">
                    <h4>üîå Data Source</h4>
                    <p>Bridge controls CSV data flow to backend</p>
                    <div style="margin-top:6px">
                        <button id="btn-ingest-internal" class="btn btn-active" onclick="setIngestion('internal')">Internal Simulator</button>
                    </div>
                    <div style="margin-top:6px">
                        <button id="btn-ingest-csv" class="btn" onclick="setIngestion('csv')">CSV Bridge (optional)</button>
                    </div>
                    <p id="ingest-hint" style="font-size:12px;color:#666;">Using Internal Simulator. Bridge controls disabled.</p>
                </div>
            </div>
        </div>

        <!-- Data Flow Visualization -->
        <div class="section">
            <h3>üìä Data Flow</h3>
                <div style="margin-top:8px">
                    <pre id="analysis-history" style="height:160px; overflow:auto; background:#111; color:#ddd; padding:10px; border-radius:6px; display:none;"></pre>
                </div>

                <div class="control-card">
                    <h4>üìú Diagnostics Logs</h4>
                    <p>Backend logs (last 200 lines)</p>
                    <div style="display:flex; gap:10px; margin-bottom:8px;">
                      <button class="btn" onclick="loadLog('sse')">View SSE Log</button>
                      <button class="btn" onclick="loadLog('ingest')">View Ingest Log</button>
                      <button class="btn" onclick="clearLog()">Clear</button>
                    </div>
                    <pre id="log-view" style="height:200px; overflow:auto; background:#111; color:#0f0; padding:10px; border-radius:6px;"></pre>
                </div>

            <div class="data-flow">
                <strong>TEP Simulation</strong> (every 3 min)
                ‚Üí <strong>CSV Export</strong>
                ‚Üí <strong>Anomaly Detection</strong> (every 6 min)
                ‚Üí <strong>LLM Diagnosis</strong> (every 12 min)
                ‚Üí <strong>FaultExplainer UI</strong>
            </div>
            <p>‚úÖ Uses original FaultExplainer backend/frontend with live data feed</p>
            <p>‚úÖ Proper timing hierarchy prevents LLM overload</p>
        </div>

            </div>
        </div>

        <!-- Level 2: Process Parameters -->
        <div id="level2-controls" class="control-level section" style="display: none;">
            <h3>üß™ Level 2: Process Parameters</h3>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 20px 0;">
                <!-- Feed Composition Control -->
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                    <h4>üß™ Feed Composition Control</h4>
                    <p><small>Adjust feed stream composition</small></p>

                    <div style="margin: 15px 0;">
                        <label><strong>Component A Ratio (Stream 4):</strong></label>
                        <input type="range" min="0.45" max="0.52" step="0.005" value="0.485"
                               id="comp-a4" onchange="adjustComposition('A', 4, this.value)"
                               style="width: 100%; margin: 5px 0;">
                        <div>Value: <span id="comp-a4-value">48.5</span>%</div>
                        <small>Normal: 48.5%, Change: <span id="comp-a4-change">0.0%</span></small>
                    </div>

                    <div style="margin: 15px 0;">
                        <label><strong>Component C Ratio (Stream 4):</strong></label>
                        <input type="range" min="0.48" max="0.55" step="0.005" value="0.510"
                               id="comp-c4" onchange="adjustComposition('C', 4, this.value)"
                               style="width: 100%; margin: 5px 0;">
                        <div>Value: <span id="comp-c4-value">51.0</span>%</div>
                        <small>Normal: 51.0%, Change: <span id="comp-c4-change">0.0%</span></small>
                    </div>
                </div>

                <!-- Temperature Control -->
                <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                    <h4>üå°Ô∏è Temperature Control</h4>
                    <p><small>Adjust process temperatures</small></p>

                    <div style="margin: 15px 0;">
                        <label><strong>Reactor Cooling Water Inlet:</strong></label>
                        <input type="range" min="20" max="35" step="0.5" value="25"
                               id="temp-rcw" onchange="adjustTemperature('reactor_cooling', this.value)"
                               style="width: 100%; margin: 5px 0;">
                        <div>Value: <span id="temp-rcw-value">25.0</span>¬∞C</div>
                        <small>Normal: 25.0¬∞C, Change: <span id="temp-rcw-change">0.0¬∞C</span></small>
                    </div>

                    <div style="margin: 15px 0;">
                        <label><strong>Condenser Cooling Water Inlet:</strong></label>
                        <input type="range" min="20" max="35" step="0.5" value="25"
                               id="temp-ccw" onchange="adjustTemperature('condenser_cooling', this.value)"
                               style="width: 100%; margin: 5px 0;">
                        <div>Value: <span id="temp-ccw-value">25.0</span>¬∞C</div>
                        <small>Normal: 25.0¬∞C, Change: <span id="temp-ccw-change">0.0¬∞C</span></small>
                    </div>
                </div>

                <!-- Flow Availability Control -->
                <div style="background: #f3e5f5; padding: 15px; border-radius: 8px;">
                    <h4>üíß Flow Availability Control</h4>
                    <p><small>Simulate feed availability issues</small></p>

                    <div style="margin: 15px 0;">
                        <label><strong>Component A Feed Availability:</strong></label>
                        <input type="range" min="50" max="100" step="5" value="100"
                               id="flow-a" onchange="adjustFlowAvailability('A', this.value)"
                               style="width: 100%; margin: 5px 0;">
                        <div>Value: <span id="flow-a-value">100</span>%</div>
                        <small>Normal: 100%, Reduction: <span id="flow-a-change">0%</span></small>
                    </div>

                    <div style="margin: 15px 0;">
                        <label><strong>Component C Feed Availability:</strong></label>
                        <input type="range" min="50" max="100" step="5" value="100"
                               id="flow-c" onchange="adjustFlowAvailability('C', this.value)"
                               style="width: 100%; margin: 5px 0;">
                        <div>Value: <span id="flow-c-value">100</span>%</div>
                        <small>Normal: 100%, Reduction: <span id="flow-c-change">0%</span></small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Level 3: Expert Fault Simulation -->
        <div id="level3-controls" class="control-level section" style="display: none;">
            <h3>üî¨ Level 3: Expert Fault Simulation</h3>

            <!-- XMV Process Controls -->
            <h4>üéõÔ∏è Process Controls (XMV Variables) - 11 Manipulated Variables</h4>
            <p><span class="correct-badge">CONTINUOUS</span> Range: 0-100% - Valve positions and control setpoints</p>
            <div class="xmv-grid">
                <!-- Feed Flow Controls -->
                <div class="xmv-control">
                    <label><strong>XMV_1:</strong> D Feed Flow</label>
                    <input type="range" class="slider" min="0" max="100" step="0.1" value="63.0"
                           onchange="setXMV(1, this.value)" id="xmv1">
                    <div>Value: <span id="xmv1-value">63.0</span>%</div>
                </div>

                <div class="xmv-control">
                    <label><strong>XMV_2:</strong> E Feed Flow</label>
                    <input type="range" class="slider" min="0" max="100" step="0.1" value="53.0"
                           onchange="setXMV(2, this.value)" id="xmv2">
                    <div>Value: <span id="xmv2-value">53.0</span>%</div>
                </div>

                <div class="xmv-control">
                    <label><strong>XMV_3:</strong> A Feed Flow</label>
                    <input type="range" class="slider" min="0" max="100" step="0.1" value="24.0"
                           onchange="setXMV(3, this.value)" id="xmv3">
                    <div>Value: <span id="xmv3-value">24.0</span>%</div>
                </div>

                <div class="xmv-control">
                    <label><strong>XMV_4:</strong> A+C Feed Flow</label>
                    <input type="range" class="slider" min="0" max="100" step="0.1" value="61.0"
                           onchange="setXMV(4, this.value)" id="xmv4">
                    <div>Value: <span id="xmv4-value">61.0</span>%</div>
                </div>

                <!-- Process Control Valves -->
                <div class="xmv-control">
                    <label><strong>XMV_5:</strong> Compressor Recycle Valve</label>
                    <input type="range" class="slider" min="0" max="100" step="0.1" value="22.0"
                           onchange="setXMV(5, this.value)" id="xmv5">
                    <div>Value: <span id="xmv5-value">22.0</span>%</div>
                </div>

                <div class="xmv-control">
                    <label><strong>XMV_6:</strong> Purge Valve</label>
                    <input type="range" class="slider" min="0" max="100" step="0.1" value="40.0"
                           onchange="setXMV(6, this.value)" id="xmv6">
                    <div>Value: <span id="xmv6-value">40.0</span>%</div>
                </div>

                <div class="xmv-control">
                    <label><strong>XMV_7:</strong> Separator Liquid Flow</label>
                    <input type="range" class="slider" min="0" max="100" step="0.1" value="38.0"
                           onchange="setXMV(7, this.value)" id="xmv7">
                    <div>Value: <span id="xmv7-value">38.0</span>%</div>
                </div>

                <div class="xmv-control">
                    <label><strong>XMV_8:</strong> Stripper Liquid Flow</label>
                    <input type="range" class="slider" min="0" max="100" step="0.1" value="46.0"
                           onchange="setXMV(8, this.value)" id="xmv8">
                    <div>Value: <span id="xmv8-value">46.0</span>%</div>
                </div>

                <div class="xmv-control">
                    <label><strong>XMV_9:</strong> Stripper Steam Valve</label>
                    <input type="range" class="slider" min="0" max="100" step="0.1" value="47.0"
                           onchange="setXMV(9, this.value)" id="xmv9">
                    <div>Value: <span id="xmv9-value">47.0</span>%</div>
                </div>

                <!-- Cooling Controls -->
                <div class="xmv-control">
                    <label><strong>XMV_10:</strong> Reactor Cooling Water</label>
                    <input type="range" class="slider" min="0" max="100" step="0.1" value="41.0"
                           onchange="setXMV(10, this.value)" id="xmv10">
                    <div>Value: <span id="xmv10-value">41.0</span>%</div>
                </div>

                <div class="xmv-control">
                    <label><strong>XMV_11:</strong> Condenser Cooling Water</label>
                    <input type="range" class="slider" min="0" max="100" step="0.1" value="18.0"
                           onchange="setXMV(11, this.value)" id="xmv11">
                    <div>Value: <span id="xmv11-value">18.0</span>%</div>
                </div>


            </div>
        </div>

        <!-- IDV Disturbance Controls -->
        <div class="section">
            <h3>üîß Disturbance Injection (IDV Controls)</h3>
            <p><span class="correct-badge">ROTARY KNOB</span> Turn dial to adjust disturbance intensity (0-100%)</p>
            <div style="margin: 10px 0;">
                <button class="btn btn-warning" onclick="testIDVImpact()">üß™ Test IDV Impact</button>
                <span style="margin-left: 10px; font-size: 12px; color: #ecf0f1;">
                    Tests if IDV changes actually affect simulation output
                </span>
            </div>
            <div class="idv-checkbox-grid" id="idv-knobs-container">
                <!-- IDV Knobs will be generated by JavaScript -->

            </div>
        </div>


    </div>

    <!-- Load external JavaScript file for Safari compatibility -->
    <script src="/static/control_panel.js?v={{ js_cache_buster }}"></script>

    <script>
        // Minimal Safari-compatible inline script
        console.log('Inline script loading...');
        console.log('User Agent:', navigator.userAgent);
        console.log('Safari detected:', navigator.userAgent.indexOf('Safari') > -1);

        // Simple test without modern syntax
        setTimeout(function() {
            console.log('Inline script test complete');
        }, 500);

        // All functions are in external JS file - no inline functions needed

        // Tab switching function
        function showTab(tabName) {
            // Hide all tab contents
            var contents = document.querySelectorAll('.tab-content');
            contents.forEach(function(content) {
                content.classList.remove('active');
            });

            // Remove active class from all tab buttons
            var buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(function(btn) {
                btn.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');

            // Add active class to clicked button
            event.target.classList.add('active');
        }



        // Level 1: Setpoint control functions
        function setSetpoint(setpoint_num, value) {
            console.log('üéØ Setting setpoint', setpoint_num, 'to', value);

            // Update display
            document.getElementById('setpt' + setpoint_num + '-value').textContent = value + (setpoint_num === 10 ? '¬∞C' : '%');

            // Send to backend
            fetch('/api/setpoint/set', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    setpoint_num: setpoint_num,
                    value: parseFloat(value)
                })
            }).then(function(response) {
                return response.json();
            }).then(function(data) {
                console.log('‚úÖ Setpoint updated:', data);
                showMessage('Setpoint ' + setpoint_num + ' set to ' + value, 'success');
            }).catch(function(error) {
                console.error('‚ùå Setpoint error:', error);
                showMessage('Failed to set setpoint: ' + error.message, 'error');
            });
        }



        // Level 2: Process parameter control functions
        function adjustComposition(component, stream, value) {
            console.log('üß™ Adjusting composition:', component, 'in stream', stream, 'to', value);

            // Update display
            var percentage = (value * 100).toFixed(1);
            document.getElementById('comp-' + component.toLowerCase() + stream + '-value').textContent = percentage;

            // Calculate change from baseline
            var baseline = component === 'A' ? 0.485 : 0.510;
            var change = ((value - baseline) * 100).toFixed(2);
            document.getElementById('comp-' + component.toLowerCase() + stream + '-change').textContent =
                (change > 0 ? '+' : '') + change + '%';

            // Convert to IDV equivalent intensity
            var idv_intensity = Math.abs(value - baseline) / 0.03; // IDV_1 uses 0.03 as base change
            var idv_num = component === 'A' ? 1 : 2;

            // Show process effect prediction
            var impact = predictCompositionImpact(component, change);
            showMessage('Composition change: ' + component + ' ' + change + '% ‚Üí ' + impact, 'info');

            // Send to backend as IDV equivalent
            fetch('/api/process/composition', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    component: component,
                    stream: stream,
                    value: value,
                    idv_equivalent: idv_num,
                    intensity: idv_intensity
                })
            }).catch(function(error) {
                console.error('‚ùå Composition adjustment error:', error);
            });
        }

        function adjustTemperature(system, value) {
            console.log('üå°Ô∏è Adjusting temperature:', system, 'to', value);

            // Update display
            document.getElementById('temp-' + system.replace('_', '-') + '-value').textContent = value;

            // Calculate change from baseline (25¬∞C)
            var change = (value - 25.0).toFixed(1);
            document.getElementById('temp-' + system.replace('_', '-') + '-change').textContent =
                (change > 0 ? '+' : '') + change + '¬∞C';

            // Convert to IDV equivalent
            var idv_intensity = Math.abs(change) / 5.0; // IDV uses 5¬∞C as base change
            var idv_num = system === 'reactor_cooling' ? 4 : 5;

            // Show process effect prediction
            var impact = predictTemperatureImpact(system, change);
            showMessage('Temperature change: ' + system + ' ' + change + '¬∞C ‚Üí ' + impact, 'info');

            // Send to backend as IDV equivalent
            fetch('/api/process/temperature', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    system: system,
                    value: value,
                    idv_equivalent: idv_num,
                    intensity: idv_intensity
                })
            }).catch(function(error) {
                console.error('‚ùå Temperature adjustment error:', error);
            });
        }

        function adjustFlowAvailability(component, value) {
            console.log('üíß Adjusting flow availability:', component, 'to', value);

            // Update display
            document.getElementById('flow-' + component.toLowerCase() + '-value').textContent = value;

            // Calculate reduction from 100%
            var reduction = (100 - value).toFixed(0);
            document.getElementById('flow-' + component.toLowerCase() + '-change').textContent = reduction + '%';

            // Convert to IDV equivalent (IDV_6 for A feed loss)
            var idv_intensity = (100 - value) / 100.0; // 0.0 = no loss, 1.0 = complete loss
            var idv_num = component === 'A' ? 6 : 7;

            // Show process effect prediction
            var impact = predictFlowImpact(component, reduction);
            showMessage('Flow availability: ' + component + ' reduced by ' + reduction + '% ‚Üí ' + impact, 'warning');

            // Send to backend as IDV equivalent
            fetch('/api/process/flow', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    component: component,
                    availability: value,
                    idv_equivalent: idv_num,
                    intensity: idv_intensity
                })
            }).catch(function(error) {
                console.error('‚ùå Flow adjustment error:', error);
            });
        }

        // Process impact prediction functions
        function predictCompositionImpact(component, change) {
            var absChange = Math.abs(parseFloat(change));
            if (absChange < 1.0) return 'Minor reaction rate change';
            if (absChange < 2.5) return 'Noticeable product quality shift';
            return 'Significant conversion loss';
        }

        function predictTemperatureImpact(system, change) {
            var absChange = Math.abs(parseFloat(change));
            if (system.includes('cooling')) {
                if (absChange < 2.0) return 'Slight temperature rise';
                if (absChange < 5.0) return 'Temperature control difficulty';
                return 'Risk of reactor runaway';
            }
            return 'Process thermal disturbance';
        }

        function predictFlowImpact(component, reduction) {
            var redValue = parseFloat(reduction);
            if (redValue < 10) return 'Minor material balance shift';
            if (redValue < 30) return 'Noticeable conversion impact';
            return 'Significant process upset';
        }

        // Monitor display update functions
        function updateMonitorDisplay() {
            // Update monitor displays when control actions are taken
            console.log('üìä Updating monitor display');

            // Fetch latest XMEAS data from backend
            fetch('/api/status')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.latest_data) {
                        // Update XMEAS displays
                        updateXMEASDisplay('monitor-xmeas1', data.latest_data.XMEAS_1, 'kscmh', 3);
                        updateXMEASDisplay('monitor-xmeas6', data.latest_data.XMEAS_6, 'kscmh', 1);
                        updateXMEASDisplay('monitor-xmeas7', data.latest_data.XMEAS_7, 'kPa', 1);
                        updateXMEASDisplay('monitor-xmeas9', data.latest_data.XMEAS_9, '¬∞C', 2);
                        updateXMEASDisplay('monitor-xmeas12', data.latest_data.XMEAS_12, '%', 1);
                        updateXMEASDisplay('monitor-xmeas13', data.latest_data.XMEAS_13, '%', 1);
                        updateXMEASDisplay('monitor-xmeas21', data.latest_data.XMEAS_21, '¬∞C', 2);
                    }
                })
                .catch(function(error) {
                    console.error('‚ùå Failed to update XMEAS display:', error);
                });
        }

        function updateXMEASDisplay(elementId, value, unit, decimals) {
            var element = document.getElementById(elementId);
            if (element && value !== undefined && value !== null) {
                var displayValue = typeof value === 'number' ? value.toFixed(decimals) : value;
                element.textContent = displayValue;
                element.style.color = '#007bff'; // Blue for active data
            }
        }

        // Auto-update XMEAS data - DISABLED to prevent duplicate polling
        // setInterval(updateMonitorDisplay, 5000); // Now handled by control_panel.js

        function logControlAction(action, details) {
            var log = document.getElementById('control-actions-log');
            if (log) {
                var timestamp = new Date().toLocaleTimeString();
                var entry = document.createElement('div');
                entry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${action}: ${details}`;
                log.insertBefore(entry, log.firstChild);

                // Keep only last 20 entries
                while (log.children.length > 20) {
                    log.removeChild(log.lastChild);
                }
            }
        }

        function updateMonitorSetpoint(setpoint_num, value) {
            var element = document.getElementById('monitor-setpt' + setpoint_num);
            if (element) {
                element.textContent = value + (setpoint_num === 10 ? '¬∞C' : '%');
            }
            logControlAction('Setpoint Change', `SETPT_${setpoint_num} = ${value}`);
        }

        function updateMonitorComposition(component, value, change) {
            var element = document.getElementById('monitor-comp-' + component.toLowerCase());
            var changeElement = document.getElementById('monitor-comp-' + component.toLowerCase() + '-change');

            if (element) {
                element.textContent = (value * 100).toFixed(1) + '%';
            }
            if (changeElement) {
                changeElement.textContent = (change > 0 ? '+' : '') + change + '%';
                changeElement.style.color = Math.abs(change) > 1 ? '#dc3545' : '#28a745';
            }
            logControlAction('Composition Change', `Component ${component} = ${(value*100).toFixed(1)}% (${change > 0 ? '+' : ''}${change}%)`);
        }

        function updateMonitorTemperature(system, value, change) {
            var element = document.getElementById('monitor-temp-' + system.replace('_', '-'));
            var changeElement = document.getElementById('monitor-temp-' + system.replace('_', '-') + '-change');

            if (element) {
                element.textContent = value + '¬∞C';
            }
            if (changeElement) {
                changeElement.textContent = (change > 0 ? '+' : '') + change + '¬∞C';
                changeElement.style.color = Math.abs(change) > 2 ? '#dc3545' : '#28a745';
            }
            logControlAction('Temperature Change', `${system} = ${value}¬∞C (${change > 0 ? '+' : ''}${change}¬∞C)`);
        }

        function updateMonitorFlow(component, availability, reduction) {
            var element = document.getElementById('monitor-flow-' + component.toLowerCase());
            var lossElement = document.getElementById('monitor-flow-' + component.toLowerCase() + '-loss');

            if (element) {
                element.textContent = availability + '%';
                element.style.color = availability < 90 ? '#dc3545' : '#28a745';
            }
            if (lossElement) {
                lossElement.textContent = reduction + '%';
                lossElement.style.color = reduction > 10 ? '#dc3545' : '#28a745';
            }
            logControlAction('Flow Availability', `Component ${component} = ${availability}% (Loss: ${reduction}%)`);
        }

        // Enhanced control functions with monitor updates
        var originalSetSetpoint = setSetpoint;
        setSetpoint = function(setpoint_num, value) {
            originalSetSetpoint(setpoint_num, value);
            updateMonitorSetpoint(setpoint_num, value);
        };

        var originalAdjustComposition = adjustComposition;
        adjustComposition = function(component, stream, value) {
            originalAdjustComposition(component, stream, value);
            var baseline = component === 'A' ? 0.485 : 0.510;
            var change = ((value - baseline) * 100).toFixed(2);
            updateMonitorComposition(component, value, change);
        };

        var originalAdjustTemperature = adjustTemperature;
        adjustTemperature = function(system, value) {
            originalAdjustTemperature(system, value);
            var change = (value - 25.0).toFixed(1);
            updateMonitorTemperature(system, value, change);
        };

        var originalAdjustFlowAvailability = adjustFlowAvailability;
        adjustFlowAvailability = function(component, value) {
            originalAdjustFlowAvailability(component, value);
            var reduction = (100 - value).toFixed(0);
            updateMonitorFlow(component, value, reduction);
        };
    </script>
        </div> <!-- End Control Tab -->

        <!-- Tab Content: Monitor -->
        <div id="monitor-tab" class="tab-content">
            <div style="background: #f8f9fa; padding: 20px; margin: 10px; border-radius: 8px;">
                <h3>üìä Real-Time Process Monitor</h3>
                <p>Live visualization of process parameters and control changes</p>

                <!-- Process Status Overview -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin: 20px 0;">
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff;">
                        <h4>üéØ Current Setpoints (Control Targets)</h4>
                        <div id="setpoint-display">
                            <div><strong>SETPT_10:</strong> Reactor Cooling Water <span id="monitor-setpt10">94.6¬∞C</span></div>
                            <div><strong>SETPT_8:</strong> Stripper Level <span id="monitor-setpt8">50%</span></div>
                            <div><strong>SETPT_7:</strong> Product Sep Level <span id="monitor-setpt7">50%</span></div>
                        </div>
                    </div>

                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                        <h4>üß™ Feed Composition (Stream 4)</h4>
                        <div id="composition-display">
                            <div>Component A: <span id="monitor-comp-a">48.5%</span> <small>(<span id="monitor-comp-a-change">0.0%</span>)</small></div>
                            <div>Component B: <span id="monitor-comp-b">0.5%</span></div>
                            <div>Component C: <span id="monitor-comp-c">51.0%</span> <small>(<span id="monitor-comp-c-change">0.0%</span>)</small></div>
                        </div>
                    </div>

                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <h4>üå°Ô∏è Process Temperatures</h4>
                        <div id="temperature-display">
                            <div>Reactor Cooling Water: <span id="monitor-temp-rcw">25.0¬∞C</span> <small>(<span id="monitor-temp-rcw-change">0.0¬∞C</span>)</small></div>
                            <div>Condenser Cooling Water: <span id="monitor-temp-ccw">25.0¬∞C</span> <small>(<span id="monitor-temp-ccw-change">0.0¬∞C</span>)</small></div>
                        </div>
                    </div>

                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #dc3545;">
                        <h4>üíß Feed Availability</h4>
                        <div id="flow-display">
                            <div>Component A Feed: <span id="monitor-flow-a">100%</span> <small>(Loss: <span id="monitor-flow-a-loss">0%</span>)</small></div>
                            <div>Component C Feed: <span id="monitor-flow-c">100%</span> <small>(Loss: <span id="monitor-flow-c-loss">0%</span>)</small></div>
                        </div>
                    </div>
                </div>

                <!-- Process Measurements -->
                <div style="background: white; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h4>üìà Key Process Measurements (XMEAS) - Live Data</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px;">
                            <strong>XMEAS_1:</strong> A Feed Flow (Stream 1)<br>
                            <span id="monitor-xmeas1" style="font-size: 18px; color: #007bff;">--</span> <small>kscmh</small><br>
                            <small style="color: #666;">Component A feed rate to reactor</small>
                        </div>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px;">
                            <strong>XMEAS_6:</strong> Reactor Feed Rate (Total)<br>
                            <span id="monitor-xmeas6" style="font-size: 18px; color: #007bff;">--</span> <small>kscmh</small><br>
                            <small style="color: #666;">Total feed to reactor (A+C+D+E)</small>
                        </div>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px;">
                            <strong>XMEAS_7:</strong> Reactor Pressure<br>
                            <span id="monitor-xmeas7" style="font-size: 18px; color: #007bff;">--</span> <small>kPa gauge</small><br>
                            <small style="color: #666;">Reactor operating pressure</small>
                        </div>
                        <div style="background: #fff3cd; padding: 10px; border-radius: 5px;">
                            <strong>XMEAS_9:</strong> Reactor Temperature<br>
                            <span id="monitor-xmeas9" style="font-size: 18px; color: #856404;">--</span> <small>¬∞C</small><br>
                            <small style="color: #856404;"><strong>Indirectly affected by SETPT_10 (via cooling system)</strong></small>
                        </div>
                        <div style="background: #e8f4fd; padding: 10px; border-radius: 5px;">
                            <strong>XMEAS_21:</strong> Reactor Coolant Temperature<br>
                            <span id="monitor-xmeas21" style="font-size: 18px; color: #0c5460;">--</span> <small>¬∞C</small><br>
                            <small style="color: #0c5460;"><strong>Directly controlled by SETPT_10</strong></small>
                        </div>
                        <div style="background: #e3f2fd; padding: 10px; border-radius: 5px;">
                            <strong>XMEAS_12:</strong> Product Separator Level<br>
                            <span id="monitor-xmeas12" style="font-size: 18px; color: #0c5460;">--</span> <small>%</small><br>
                            <small style="color: #0c5460;"><strong>Controlled by SETPT_7</strong></small>
                        </div>
                        <div style="background: #e3f2fd; padding: 10px; border-radius: 5px;">
                            <strong>XMEAS_13:</strong> Stripper Level<br>
                            <span id="monitor-xmeas13" style="font-size: 18px; color: #0c5460;">--</span> <small>%</small><br>
                            <small style="color: #0c5460;"><strong>Controlled by SETPT_8</strong></small>
                        </div>
                    </div>
                </div>

                <!-- Control Actions Log -->
                <div style="background: white; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h4>üìù Recent Control Actions</h4>
                    <div id="control-actions-log" style="max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                        <div style="color: #666;">System ready - no actions yet</div>
                    </div>
                </div>

                <!-- Anomaly Detection Status -->
                <div style="background: white; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h4>üö® Anomaly Detection Status</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <strong>PCA Status:</strong> <span id="monitor-pca-status" style="color: #28a745;">Normal</span><br>
                            <strong>Last Check:</strong> <span id="monitor-pca-time">--</span><br>
                            <strong>Anomaly Score:</strong> <span id="monitor-anomaly-score">--</span>
                        </div>
                        <div>
                            <strong>LLM Analysis:</strong> <span id="monitor-llm-status" style="color: #6c757d;">Standby</span><br>
                            <strong>Last Analysis:</strong> <span id="monitor-llm-time">--</span><br>
                            <strong>Confidence:</strong> <span id="monitor-llm-confidence">--</span>
                        </div>
                    </div>
                </div>

                <!-- Independent LLM Analysis Display -->
                <div style="background: white; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h4>ü§ñ Independent LLM Analysis Results</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; min-height: 300px;">

                        <!-- LMStudio Results -->
                        <div style="border: 2px solid #007bff; border-radius: 8px; padding: 15px; background: #f8f9ff;">
                            <h5 style="color: #007bff; margin: 0 0 10px 0;">üñ•Ô∏è LMStudio (Local Model)</h5>
                            <div id="lmstudio-status" style="font-size: 12px; color: #666; margin-bottom: 10px;">
                                Status: <span id="lmstudio-state">Standby</span> |
                                Duration: <span id="lmstudio-duration">--</span>s |
                                Time: <span id="lmstudio-time">--</span>
                            </div>
                            <div id="lmstudio-result" style="background: white; padding: 10px; border-radius: 4px; min-height: 200px; font-size: 13px; overflow-y: auto; border: 1px solid #ddd;">
                                <div style="color: #666; text-align: center; padding: 50px 10px;">
                                    Á≠âÂæÖÂàÜÊûêÁªìÊûú...
                                </div>
                            </div>
                            <div style="margin-top: 10px; text-align: center; display: flex; gap: 10px; justify-content: center;">
                                <button onclick="freezeLMStudioDisplay()" style="padding: 5px 10px; font-size: 11px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                    ÂÜªÁªìÊòæÁ§∫
                                </button>
                                <button onclick="resetLMStudioConnection()" style="padding: 5px 10px; font-size: 11px; background: #ff6b6b; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                    üîÑ Reset Connection
                                </button>
                            </div>
                        </div>

                        <!-- Gemini Results -->
                        <div style="border: 2px solid #28a745; border-radius: 8px; padding: 15px; background: #f8fff8;">
                            <h5 style="color: #28a745; margin: 0 0 10px 0;">üíé Gemini (Google AI)</h5>
                            <div id="gemini-status" style="font-size: 12px; color: #666; margin-bottom: 10px;">
                                Status: <span id="gemini-state">Standby</span> |
                                Duration: <span id="gemini-duration">--</span>s |
                                Time: <span id="gemini-time">--</span>
                            </div>
                            <div id="gemini-result" style="background: white; padding: 10px; border-radius: 4px; min-height: 200px; font-size: 13px; overflow-y: auto; border: 1px solid #ddd;">
                                <div style="color: #666; text-align: center; padding: 50px 10px;">
                                    Á≠âÂæÖÂàÜÊûêÁªìÊûú...
                                </div>
                            </div>
                            <div style="margin-top: 10px; text-align: center;">
                                <button onclick="freezeGeminiDisplay()" style="padding: 5px 10px; font-size: 11px; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                    ÂÜªÁªìÊòæÁ§∫
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- MD Files Location Info -->
                    <div style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 4px; font-size: 12px; color: #666;">
                        üìÅ <strong>ÂàÜÊûêÁªìÊûú‰øùÂ≠ò‰ΩçÁΩÆ:</strong><br>
                        ‚Ä¢ LMStudio: <code id="lmstudio-file-path">RCA_Results/LMStudio_MMDD.md</code><br>
                        ‚Ä¢ Gemini: <code id="gemini-file-path">RCA_Results/Gemini_MMDD.md</code>
                        <script>
                            // Update file paths with current date (ES5 compatible)
                            var today = new Date();
                            var month = today.getMonth() + 1;
                            var day = today.getDate();
                            var mmdd = (month < 10 ? '0' : '') + month + (day < 10 ? '0' : '') + day;
                            document.getElementById('lmstudio-file-path').textContent = 'RCA_Results/LMStudio_' + mmdd + '.md';
                            document.getElementById('gemini-file-path').textContent = 'RCA_Results/Gemini_' + mmdd + '.md';
                        </script>
                    </div>
                </div>
            </div>
        </div> <!-- End Monitor Tab -->

        <!-- Tab Content: Documentation -->
        <div id="docs-tab" class="tab-content">
            <div class="docs-section">
                <h3>üìö Knowledge Base Management</h3>
                <p style="color:#666; margin-bottom:20px;">
                    Manage RAG (Retrieval-Augmented Generation) knowledge base for enhanced LLM diagnosis.
                    Add documents ‚Üí Convert to Markdown ‚Üí Reindex ‚Üí Use in Interactive RCA
                </p>

                <!-- Step 1: Add Documents -->
                <div class="control-card" style="margin-bottom:20px;">
                    <h4>üìÅ Step 1: Add Documents</h4>
                    <p style="font-size:14px; color:#666;">Upload PDF, Markdown, or Text files to add to the knowledge base</p>
                    
                    <input type="file" id="kb-file-upload" multiple accept=".pdf,.md,.txt" style="margin:10px 0; padding:8px; border:1px solid #ddd; border-radius:4px; width:100%;">
                    
                    <div id="kb-selected-files" style="margin:10px 0; padding:10px; background:#f8f9fa; border-radius:4px; min-height:40px;">
                        <p style="color:#888; margin:0;">No files selected</p>
                    </div>
                    
                    <button class="btn" onclick="clearSelectedFiles()" style="margin-right:10px;">Clear Selection</button>
                </div>

                <!-- Step 2: Convert to Markdown -->
                <div class="control-card" style="margin-bottom:20px;">
                    <h4>üîÑ Step 2: Convert to Knowledge Base Format</h4>
                    <p style="font-size:14px; color:#666;">Convert PDFs to Markdown format and save to knowledge base directory</p>
                    
                    <div style="margin:10px 0;">
                        <label style="font-size:12px; color:#666;">Output Directory:</label>
                        <input type="text" id="kb-output-dir" value="RAG/converted_markdown/" readonly 
                               style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; background:#f8f9fa; margin-top:4px;">
                    </div>
                    
                    <button class="btn btn-primary" onclick="convertDocuments()" id="btn-convert-docs" style="margin-top:10px;">
                        üîÑ Convert & Save Documents
                    </button>
                    
                    <div id="kb-conversion-status" style="margin-top:10px; padding:10px; background:#f8f9fa; border-radius:4px; display:none;">
                        <p style="margin:0; font-size:14px;" id="kb-conversion-message"></p>
                        <div class="progress-bar" id="kb-progress-bar" style="margin-top:8px; display:none;">
                            <div class="progress-fill" id="kb-progress-fill" style="width:0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Reindex Knowledge -->
                <div class="control-card" style="margin-bottom:20px;">
                    <h4>üîç Step 3: Reindex Knowledge Base</h4>
                    <p style="font-size:14px; color:#666;">Build semantic index from all markdown files for fast RAG retrieval</p>
                    
                    <button class="btn btn-primary" onclick="ragReindex()" id="btn-rag-reindex-main">
                        üîç Reindex Knowledge Base
                    </button>
                    
                    <div id="kb-reindex-status" style="margin-top:10px; padding:10px; background:#f8f9fa; border-radius:4px; display:none;">
                        <p style="margin:0; font-size:14px;" id="kb-reindex-message"></p>
                    </div>
                </div>

                <!-- Current Knowledge Base -->
                <div class="control-card">
                    <h4>üìã Current Knowledge Base</h4>
                    <p style="font-size:14px; color:#666;">Documents currently indexed in the knowledge base</p>
                    
                    <button class="btn" onclick="loadKnowledgeBaseList()" style="margin-bottom:10px;">
                        üîÑ Refresh List
                    </button>
                    
                    <div id="kb-document-list" style="max-height:400px; overflow-y:auto; border:1px solid #ddd; border-radius:4px; padding:10px; background:#fff;">
                        <p style="color:#888; text-align:center;">Click "Refresh List" to load documents</p>
                    </div>
                </div>

                <!-- Knowledge Base Statistics -->
                <div class="control-card" style="margin-top:20px;">
                    <h4>üìä Knowledge Base Statistics</h4>
                    <div id="kb-stats" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-top:10px;">
                        <div style="padding:15px; background:#e3f2fd; border-radius:6px;">
                            <p style="margin:0; font-size:12px; color:#666;">Total Documents</p>
                            <p style="margin:5px 0 0 0; font-size:24px; font-weight:bold;" id="kb-stat-docs">-</p>
                        </div>
                        <div style="padding:15px; background:#f3e5f5; border-radius:6px;">
                            <p style="margin:0; font-size:12px; color:#666;">Total Chunks</p>
                            <p style="margin:5px 0 0 0; font-size:24px; font-weight:bold;" id="kb-stat-chunks">-</p>
                        </div>
                        <div style="padding:15px; background:#e8f5e9; border-radius:6px;">
                            <p style="margin:0; font-size:12px; color:#666;">Last Indexed</p>
                            <p style="margin:5px 0 0 0; font-size:14px; font-weight:bold;" id="kb-stat-time">-</p>
                        </div>
                    </div>
                </div>

                <!-- Help Section -->
                <div class="docs-section" style="margin-top:30px; padding-top:20px; border-top:2px solid #e0e0e0;">
                    <h4>‚ùì How to Use Knowledge Base</h4>
                    <ol style="line-height:1.8;">
                        <li><strong>Add Documents:</strong> Upload PDF files (research papers, manuals, theses)</li>
                        <li><strong>Convert:</strong> Click "Convert & Save Documents" to process PDFs into markdown format</li>
                        <li><strong>Reindex:</strong> Click "Reindex Knowledge Base" to make documents searchable</li>
                        <li><strong>Use in Analysis:</strong> Navigate to "Interactive RCA" in frontend - LLM responses will include relevant excerpts</li>
                    </ol>
                    
                    <p style="margin-top:15px; padding:10px; background:#fff3cd; border-left:4px solid #ffc107; border-radius:4px;">
                        <strong>üí° Tip:</strong> After adding new documents, always click "Reindex Knowledge Base" to make them available to the LLM system.
                    </p>
                </div>
            </div>
        </div> <!-- End Knowledge Base Tab -->


        <script>
        // ===== Knowledge Base Management Functions =====

        // Handle file selection
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('kb-file-upload');
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    const files = e.target.files;
                    const fileList = document.getElementById('kb-selected-files');

                    if (files.length === 0) {
                        fileList.innerHTML = '<p style="color:#888; margin:0;">No files selected</p>';
                        return;
                    }

                    let html = '<ul style="margin:0; padding-left:20px;">';
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        const size = (file.size / 1024).toFixed(1);
                        html += `<li style="margin:5px 0;">${file.name} (${size} KB)</li>`;
                    }
                    html += '</ul>';
                    fileList.innerHTML = html;
                });
            }
        });

        function clearSelectedFiles() {
            const fileInput = document.getElementById('kb-file-upload');
            const fileList = document.getElementById('kb-selected-files');

            if (fileInput) {
                fileInput.value = '';
            }
            if (fileList) {
                fileList.innerHTML = '<p style="color:#888; margin:0;">No files selected</p>';
            }
        }

        function convertDocuments() {
            const fileInput = document.getElementById('kb-file-upload');
            const statusDiv = document.getElementById('kb-conversion-status');
            const messageEl = document.getElementById('kb-conversion-message');
            const btnConvert = document.getElementById('btn-convert-docs');

            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                showMessage('Please select files to convert', 'error');
                return;
            }

            const formData = new FormData();
            for (let i = 0; i < fileInput.files.length; i++) {
                formData.append('files', fileInput.files[i]);
            }

            // Show status
            statusDiv.style.display = 'block';
            messageEl.innerHTML = 'üîÑ Converting documents...';
            messageEl.style.color = '#1976d2';
            btnConvert.disabled = true;
            btnConvert.textContent = '‚è≥ Converting...';

            fetch('http://127.0.0.1:8000/api/knowledge_base/convert', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    messageEl.innerHTML = `‚úÖ ${data.message}<br>Converted: ${data.converted_count} files<br>Saved to: ${data.output_dir}`;
                    messageEl.style.color = '#2e7d32';
                    showMessage('Documents converted successfully!', 'success');

                    // Auto-refresh document list
                    setTimeout(loadKnowledgeBaseList, 1000);
                } else {
                    messageEl.innerHTML = `‚ùå Error: ${data.message}`;
                    messageEl.style.color = '#c62828';
                    showMessage('Conversion failed: ' + data.message, 'error');
                }
            })
            .catch(error => {
                messageEl.innerHTML = `‚ùå Error: ${error.message}`;
                messageEl.style.color = '#c62828';
                showMessage('Conversion error: ' + error.message, 'error');
            })
            .finally(() => {
                btnConvert.disabled = false;
                btnConvert.textContent = 'üîÑ Convert & Save Documents';
            });
        }

        function ragReindex() {
            const statusDiv = document.getElementById('kb-reindex-status');
            const messageEl = document.getElementById('kb-reindex-message');
            const btnReindex = document.getElementById('btn-rag-reindex-main');

            // Show status
            if (statusDiv) statusDiv.style.display = 'block';
            if (messageEl) {
                messageEl.innerHTML = 'üîÑ Reindexing knowledge base...';
                messageEl.style.color = '#1976d2';
            }
            if (btnReindex) {
                btnReindex.disabled = true;
                btnReindex.textContent = '‚è≥ Reindexing...';
            }

            fetch('http://127.0.0.1:8000/api/knowledge_base/reindex', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    if (messageEl) {
                        messageEl.innerHTML = `‚úÖ ${data.message}<br>Documents: ${data.document_count}<br>Chunks: ${data.chunk_count}`;
                        messageEl.style.color = '#2e7d32';
                    }
                    showMessage('Knowledge base reindexed successfully!', 'success');

                    // Update statistics
                    updateKnowledgeBaseStats(data);

                    // Refresh document list
                    setTimeout(loadKnowledgeBaseList, 1000);
                } else {
                    if (messageEl) {
                        messageEl.innerHTML = `‚ùå Error: ${data.message}`;
                        messageEl.style.color = '#c62828';
                    }
                    showMessage('Reindex failed: ' + data.message, 'error');
                }
            })
            .catch(error => {
                if (messageEl) {
                    messageEl.innerHTML = `‚ùå Error: ${error.message}`;
                    messageEl.style.color = '#c62828';
                }
                showMessage('Reindex error: ' + error.message, 'error');
            })
            .finally(() => {
                if (btnReindex) {
                    btnReindex.disabled = false;
                    btnReindex.textContent = 'üîç Reindex Knowledge Base';
                }
            });
        }

        function loadKnowledgeBaseList() {
            const listDiv = document.getElementById('kb-document-list');

            listDiv.innerHTML = '<p style="color:#888; text-align:center;">Loading...</p>';

            fetch('http://127.0.0.1:8000/api/knowledge_base/list')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.documents) {
                    if (data.documents.length === 0) {
                        listDiv.innerHTML = '<p style="color:#888; text-align:center;">No documents found. Add documents to get started.</p>';
                        return;
                    }

                    let html = '<div style="display:grid; gap:10px;">';
                    data.documents.forEach(doc => {
                        const sizeKB = (doc.size / 1024).toFixed(1);
                        html += `
                            <div style="padding:12px; border:1px solid #e0e0e0; border-radius:6px; background:#fafafa;">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <div>
                                        <p style="margin:0; font-weight:600;">${doc.name}</p>
                                        <p style="margin:4px 0 0 0; font-size:12px; color:#666;">${sizeKB} KB ‚Ä¢ ${doc.modified}</p>
                                    </div>
                                    <div style="display:flex; gap:8px;">
                                        <button class="btn" style="padding:4px 12px; font-size:12px;" onclick="viewDocument('${doc.name}')">üëÅ View</button>
                                        <button class="btn" style="padding:4px 12px; font-size:12px; background:#c62828; color:white;" onclick="deleteDocument('${doc.name}')">üóë Delete</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    listDiv.innerHTML = html;

                    // Update statistics
                    updateKnowledgeBaseStats(data);
                } else {
                    listDiv.innerHTML = '<p style="color:#c62828; text-align:center;">Error loading documents</p>';
                }
            })
            .catch(error => {
                listDiv.innerHTML = '<p style="color:#c62828; text-align:center;">Error: ' + error.message + '</p>';
            });
        }

        function updateKnowledgeBaseStats(data) {
            if (data.document_count !== undefined) {
                document.getElementById('kb-stat-docs').textContent = data.document_count;
            }
            if (data.chunk_count !== undefined) {
                document.getElementById('kb-stat-chunks').textContent = data.chunk_count;
            }
            if (data.last_indexed) {
                document.getElementById('kb-stat-time').textContent = new Date(data.last_indexed).toLocaleString();
            }
        }

        function viewDocument(docName) {
            fetch(`http://127.0.0.1:8000/api/knowledge_base/view/${encodeURIComponent(docName)}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Create modal to show document content
                    const modal = document.createElement('div');
                    modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; display:flex; align-items:center; justify-content:center;';
                    modal.innerHTML = `
                        <div style="background:white; padding:30px; border-radius:8px; max-width:800px; max-height:80%; overflow:auto; width:90%;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:2px solid #e0e0e0; padding-bottom:10px;">
                                <h3 style="margin:0;">${docName}</h3>
                                <button onclick="this.closest('div').parentElement.parentElement.remove()" style="background:#c62828; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">Close</button>
                            </div>
                            <pre style="white-space:pre-wrap; font-size:13px; line-height:1.6; font-family:monospace; background:#f5f5f5; padding:15px; border-radius:4px; max-height:500px; overflow:auto;">${data.content}</pre>
                        </div>
                    `;
                    document.body.appendChild(modal);
                } else {
                    showMessage('Error viewing document: ' + data.message, 'error');
                }
            })
            .catch(error => {
                showMessage('Error: ' + error.message, 'error');
            });
        }

        function deleteDocument(docName) {
            if (!confirm(`Are you sure you want to delete "${docName}"?\n\nThis action cannot be undone.`)) {
                return;
            }

            fetch(`http://127.0.0.1:8000/api/knowledge_base/delete/${encodeURIComponent(docName)}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showMessage('Document deleted successfully', 'success');
                    loadKnowledgeBaseList(); // Refresh list
                } else {
                    showMessage('Error deleting document: ' + data.message, 'error');
                }
            })
            .catch(error => {
                showMessage('Error: ' + error.message, 'error');
            });
        }

        // ===== End Knowledge Base Management Functions =====


        // Utility functions
        function updateJSStatus(status) {
            var statusElement = document.getElementById('js-status');
            if (statusElement) {
                statusElement.textContent = status;
                statusElement.style.color = status.includes('‚úÖ') ? 'green' :
                                           status.includes('‚ùå') ? 'red' : 'orange';
            }
            console.log('üìä JS Status:', status);
        }

        function showMessage(message, type) {
            console.log('üí¨ Message (' + type + '):', message);

            // Create or update message display
            var messageDiv = document.getElementById('message-display');
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                messageDiv.id = 'message-display';
                messageDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 1000; max-width: 300px;';
                document.body.appendChild(messageDiv);
            }

            var alertDiv = document.createElement('div');
            var bgColor = type === 'success' ? '#d4edda' :
                         type === 'error' ? '#f8d7da' :
                         type === 'warning' ? '#fff3cd' : '#d1ecf1';
            var textColor = type === 'success' ? '#155724' :
                           type === 'error' ? '#721c24' :
                           type === 'warning' ? '#856404' : '#0c5460';

            alertDiv.style.cssText = `
                background: ${bgColor};
                color: ${textColor};
                padding: 10px;
                margin: 5px 0;
                border-radius: 5px;
                border: 1px solid ${textColor};
                font-size: 12px;
            `;
            alertDiv.textContent = message;

            messageDiv.appendChild(alertDiv);

            // Auto-remove after 5 seconds
            setTimeout(function() {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        // Independent LLM Display Management
        let lmstudioFrozen = false;
        let geminiFrozen = false;
        let lmstudioDisplayTimer = null;
        let geminiDisplayTimer = null;

        function freezeLMStudioDisplay() {
            lmstudioFrozen = !lmstudioFrozen;
            const btn = event.target;
            if (lmstudioFrozen) {
                btn.textContent = 'Ëß£Èô§ÂÜªÁªì';
                btn.style.background = '#dc3545';
                console.log('üßä LMStudio display frozen');
            } else {
                btn.textContent = 'ÂÜªÁªìÊòæÁ§∫';
                btn.style.background = '#007bff';
                console.log('üîÑ LMStudio display unfrozen');
            }
        }

        function freezeGeminiDisplay() {
            geminiFrozen = !geminiFrozen;
            const btn = event.target;
            if (geminiFrozen) {
                btn.textContent = 'Ëß£Èô§ÂÜªÁªì';
                btn.style.background = '#dc3545';
                console.log('üßä Gemini display frozen');
            } else {
                btn.textContent = 'ÂÜªÁªìÊòæÁ§∫';
                btn.style.background = '#28a745';
                console.log('üîÑ Gemini display unfrozen');
            }
        }

        function resetLMStudioConnection() {
            console.log('üîÑ Resetting LMStudio connection...');

            // Clear display and show loading state
            document.getElementById('lmstudio-state').textContent = 'Resetting...';
            document.getElementById('lmstudio-duration').textContent = '--';
            document.getElementById('lmstudio-result').innerHTML = `
                <div style="color: #ff6b6b; text-align: center; padding: 50px 10px;">
                    <strong>üîÑ Resetting LMStudio Connection...</strong><br>
                    <small style="color: #666; margin-top: 10px; display: block;">This will clear any stuck requests and reset rate limiting.</small>
                </div>
            `;

            // Call backend API to reset LMStudio connection
            fetch('http://127.0.0.1:8000/reset_lmstudio', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('‚úÖ LMStudio reset response:', data);

                // Update display
                document.getElementById('lmstudio-state').textContent = 'Ready';
                document.getElementById('lmstudio-result').innerHTML = `
                    <div style="color: #28a745; text-align: center; padding: 50px 10px;">
                        <strong>‚úÖ ${data.message || 'Connection Reset Complete'}</strong><br>
                        <small style="color: #666; margin-top: 10px; display: block;">${data.details || 'Rate limiting cleared. Ready for new requests.'}</small>
                    </div>
                `;

                // Auto-clear after 5 seconds
                setTimeout(() => {
                    if (!lmstudioFrozen) {
                        document.getElementById('lmstudio-result').innerHTML = '<div style="color: #666; text-align: center; padding: 50px 10px;">Á≠âÂæÖÂàÜÊûêÁªìÊûú...</div>';
                        document.getElementById('lmstudio-state').textContent = 'Standby';
                    }
                }, 5000);
            })
            .catch(error => {
                console.error('‚ùå LMStudio reset error:', error);
                document.getElementById('lmstudio-state').textContent = 'Error';
                document.getElementById('lmstudio-result').innerHTML = `
                    <div style="color: #dc3545; text-align: center; padding: 50px 10px;">
                        <strong>‚ùå Reset Failed</strong><br>
                        <small style="color: #666; margin-top: 10px; display: block;">${error.message}</small>
                    </div>
                `;
            });
        }

        function updateIndependentLLMResult(modelName, result) {
            console.log(`ü§ñ Updating ${modelName} result:`, result);

            if (modelName === 'lmstudio' && !lmstudioFrozen) {
                document.getElementById('lmstudio-state').textContent = result.status || 'Processing';
                document.getElementById('lmstudio-duration').textContent = result.response_time || '--';
                document.getElementById('lmstudio-time').textContent = new Date().toLocaleTimeString();
                document.getElementById('lmstudio-result').innerHTML = `<pre style="white-space: pre-wrap; margin: 0;">${result.response || 'ÂàÜÊûê‰∏≠...'}</pre>`;

                // Auto-hide after 10 seconds unless frozen
                if (lmstudioDisplayTimer) clearTimeout(lmstudioDisplayTimer);
                lmstudioDisplayTimer = setTimeout(() => {
                    if (!lmstudioFrozen) {
                        document.getElementById('lmstudio-result').innerHTML = '<div style="color: #666; text-align: center; padding: 50px 10px;">Á≠âÂæÖ‰∏ãÊ¨°ÂàÜÊûê...</div>';
                        document.getElementById('lmstudio-state').textContent = 'Standby';
                    }
                }, 10000);
            }

            if (modelName === 'gemini' && !geminiFrozen) {
                document.getElementById('gemini-state').textContent = result.status || 'Processing';
                document.getElementById('gemini-duration').textContent = result.response_time || '--';
                document.getElementById('gemini-time').textContent = new Date().toLocaleTimeString();
                document.getElementById('gemini-result').innerHTML = `<pre style="white-space: pre-wrap; margin: 0;">${result.response || 'ÂàÜÊûê‰∏≠...'}</pre>`;

                // Auto-hide after 10 seconds unless frozen
                if (geminiDisplayTimer) clearTimeout(geminiDisplayTimer);
                geminiDisplayTimer = setTimeout(() => {
                    if (!geminiFrozen) {
                        document.getElementById('gemini-result').innerHTML = '<div style="color: #666; text-align: center; padding: 50px 10px;">Á≠âÂæÖ‰∏ãÊ¨°ÂàÜÊûê...</div>';
                        document.getElementById('gemini-state').textContent = 'Standby';
                    }
                }, 10000);
            }
        }

        // IDV Rotary Knob Configuration
        var idvKnobs = [
            {id: 1, name: '1. Increase A Feed', desc: 'A/C Feed Ratio Change'},
            {id: 2, name: '2. B Composition Change', desc: 'Feed Quality Variation'},
            {id: 3, name: '3. D Feed Temperature', desc: 'Thermal Disturbance'},
            {id: 4, name: '4. Reactor Cooling Fault', desc: 'Heat Removal Issues'},
            {id: 5, name: '5. Condenser Cooling Fault', desc: 'Cooling System Problems'},
            {id: 6, name: '6. A Feed Loss', desc: 'Feed Supply Interruption'},
            {id: 7, name: '7. C Header Pressure Loss', desc: 'Reduced Availability'},
            {id: 8, name: '8. Feed Composition Drift', desc: 'A,B,C Random Variation'},
            {id: 9, name: '9. D Feed Temperature Drift', desc: 'Random Variation'},
            {id: 10, name: '10. C Feed Temperature Drift', desc: 'Random Variation'},
            {id: 11, name: '11. Reactor Cooling Drift', desc: 'Random Temperature Variation'},
            {id: 12, name: '12. Condenser Cooling Drift', desc: 'Random Temperature Variation'},
            {id: 13, name: '13. Reaction Kinetics Drift', desc: 'Catalyst Deactivation'},
            {id: 14, name: '14. Reactor Cooling Valve Fault', desc: 'Valve Sticking'},
            {id: 15, name: '15. Condenser Cooling Valve Fault', desc: 'Valve Sticking'}
        ];

        var idvValues = {};  // Store current values
        var isDragging = {};  // Track dragging state

        function createRotaryKnob(idvConfig) {
            var container = document.createElement('div');
            container.className = 'idv-knob-container';

            var label = document.createElement('div');
            label.className = 'idv-knob-label';
            label.innerHTML = '<strong>' + idvConfig.name + '</strong><br><small>' + idvConfig.desc + '</small>';

            var knobWrapper = document.createElement('div');
            knobWrapper.className = 'idv-knob';
            knobWrapper.id = 'knob-' + idvConfig.id;

            var knobBg = document.createElement('div');
            knobBg.className = 'idv-knob-bg';

            var indicator = document.createElement('div');
            indicator.className = 'idv-knob-indicator';
            indicator.id = 'indicator-' + idvConfig.id;

            var valueDisplay = document.createElement('div');
            valueDisplay.className = 'idv-knob-value';
            valueDisplay.id = 'value-' + idvConfig.id;
            valueDisplay.textContent = '0%';

            knobBg.appendChild(indicator);
            knobWrapper.appendChild(knobBg);
            container.appendChild(label);
            container.appendChild(knobWrapper);
            container.appendChild(valueDisplay);

            // Initialize value
            idvValues[idvConfig.id] = 0;
            isDragging[idvConfig.id] = false;

            // Add mouse/touch event listeners
            knobWrapper.addEventListener('mousedown', function(e) { startDrag(e, idvConfig.id); });
            knobWrapper.addEventListener('touchstart', function(e) { startDrag(e, idvConfig.id); });

            return container;
        }

        function startDrag(e, idvId) {
            e.preventDefault();
            isDragging[idvId] = true;
            document.addEventListener('mousemove', function(e) { onDrag(e, idvId); });
            document.addEventListener('mouseup', function() { stopDrag(idvId); });
            document.addEventListener('touchmove', function(e) { onDrag(e, idvId); });
            document.addEventListener('touchend', function() { stopDrag(idvId); });
        }

        function onDrag(e, idvId) {
            if (!isDragging[idvId]) return;

            var knob = document.getElementById('knob-' + idvId);
            var rect = knob.getBoundingClientRect();
            var centerX = rect.left + rect.width / 2;
            var centerY = rect.top + rect.height / 2;

            var clientX = e.clientX || (e.touches && e.touches[0].clientX);
            var clientY = e.clientY || (e.touches && e.touches[0].clientY);

            var angle = Math.atan2(clientY - centerY, clientX - centerX);
            var degrees = angle * (180 / Math.PI) + 90;
            if (degrees < 0) degrees += 360;

            // Map 0-360 degrees to 0-100%
            var value = Math.round((degrees / 360) * 100);
            value = Math.max(0, Math.min(100, value));

            updateKnobValue(idvId, value);
        }

        function stopDrag(idvId) {
            isDragging[idvId] = false;
        }

        function updateKnobValue(idvId, value) {
            idvValues[idvId] = value;

            // Update visual indicator rotation
            var indicator = document.getElementById('indicator-' + idvId);
            var degrees = (value / 100) * 360;
            indicator.style.transform = 'rotate(' + degrees + 'deg)';

            // Update value display
            var valueDisplay = document.getElementById('value-' + idvId);
            valueDisplay.textContent = value + '%';

            // Send to backend
            fetch('/api/idv/set', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({idv_num: idvId, value: value / 100})
            }).then(function(response) {
                return response.json();
            }).then(function(data) {
                console.log('‚úÖ IDV_' + idvId + ' set to ' + value + '%');
            }).catch(function(error) {
                console.error('‚ùå IDV error:', error);
            });
        }

        // Initialize simplified control system when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéõÔ∏è TEP Control Panel loaded');

            // Generate rotary knobs
            var container = document.getElementById('idv-knobs-container');
            idvKnobs.forEach(function(config) {
                container.appendChild(createRotaryKnob(config));
            });

            // Log initial system state
            logControlAction('System Startup', 'Control Panel initialized');

            // Update JavaScript status
            updateJSStatus('‚úÖ Ready');

            // Show welcome message
            showMessage('TEP Control Panel ready! Turn IDV knobs to inject faults.', 'success');

            // Start polling for independent LLM results (SMART POLLING - only when backend running)
            setInterval(pollIndependentLLMResults, 5000); // Check every 5 seconds (reduced from 2s to avoid 429)
        });

        function pollIndependentLLMResults() {
            // ONLY poll if backend is actually running (check status first)
            fetch('/api/status')
                .then(response => response.json())
                .then(statusData => {
                    // Only poll LLM results if backend is running
                    if (statusData.backend_running) {
                        return fetch('/api/llm/independent-results');
                    } else {
                        // Backend not running, skip polling
                        return null;
                    }
                })
                .then(response => {
                    if (response) {
                        return response.json();
                    }
                    return null;
                })
                .then(data => {
                    if (data) {
                        if (data.lmstudio) {
                            updateIndependentLLMResult('lmstudio', data.lmstudio);
                        }
                        if (data.gemini) {
                            updateIndependentLLMResult('gemini', data.gemini);
                        }
                    }
                })
                .catch(error => {
                    // Silently handle errors - backend might be stopped
                });
        }

        // =========================================================================
        // Analysis History Functions
        // =========================================================================

        // üîß NEW: Auto-refresh functionality for Load History
        let autoRefreshInterval = null;
        let autoRefreshEnabled = false;

        function toggleAutoRefresh(enabled) {
            autoRefreshEnabled = enabled;

            if (enabled) {
                console.log('‚úÖ Load History auto-refresh enabled (30s interval)');
                // Load immediately when enabled
                showAnalysisHistory();
                // Then set interval for recurring loads
                autoRefreshInterval = setInterval(() => {
                    console.log('üîÑ Auto-refreshing Load History...');
                    showAnalysisHistory();
                }, 30000); // 30 seconds
            } else {
                console.log('‚è∏Ô∏è Load History auto-refresh disabled');
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }

        function showAnalysisHistory() {
            const limit = parseInt(document.getElementById('history-limit')?.value || 5);

            // üîß FIX: Use unified console proxy instead of direct backend call
            // Add timestamp to bust any aggressive browser caching
            const timestamp = Date.now();
            fetch(`/api/backend/analysis/history?limit=${limit}&_t=${timestamp}`, {
                cache: 'no-store'  // Prevent browser caching stale data
            })
                .then(response => response.json())
                .then(data => {
                    const logView = document.getElementById('log-view');

                    if (data.items && data.items.length > 0) {
                        // Reverse once and save to window for button clicks
                        const reversedItems = data.items.slice().reverse();
                        window.analysisHistoryItems = reversedItems;

                        // Build HTML instead of plain text to support clickable links
                        let html = '<div style="font-family: monospace; white-space: pre-wrap; padding: 10px;">';
                        html += '<div style="color: #00ff00; font-weight: bold;">üìä Last ' + reversedItems.length + ' Analysis Records</div>';
                        html += '<div style="color: #666;">‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê</div><br>';

                        reversedItems.forEach((item, index) => {
                            const timestamp = new Date(item.timestamp || item.time || Date.now()).toLocaleString();

                            html += '<div style="color: #666;">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>';
                            html += '<div style="color: #0ff;">üìå Analysis #' + (index + 1) + ' | üïê ' + timestamp + '</div>';
                            html += '<div style="color: #888;">üÜî ID: ' + (item.id || 'N/A') + '</div><br>';

                            // FULL Feature Analysis
                            if (item.feature_analysis) {
                                html += '<div style="color: #ff0;">üîç FEATURE ANALYSIS:</div>';
                                html += '<div style="color: #ddd;">' + escapeHtml(item.feature_analysis) + '</div><br>';
                            }

                            // FULL LLM Analyses
                            if (item.llm_analyses) {
                                html += '<div style="color: #ff0;">ü§ñ LLM ROOT CAUSE ANALYSES:</div><br>';
                                Object.keys(item.llm_analyses).forEach(modelName => {
                                    const analysis = item.llm_analyses[modelName];
                                    if (analysis && analysis.analysis) {
                                        html += '<div style="color: #0f0;">‚îÅ‚îÅ‚îÅ ' + modelName.toUpperCase() + ' ‚îÅ‚îÅ‚îÅ</div>';
                                        html += '<div style="color: #aaa;">Status: ' + (analysis.status || 'unknown') + '</div>';
                                        if (analysis.response_time) {
                                            html += '<div style="color: #aaa;">Response Time: ' + analysis.response_time.toFixed(2) + 's</div>';
                                        }
                                        html += '<div style="color: #ddd;">' + escapeHtml(analysis.analysis) + '</div><br>';
                                    }
                                });
                            }

                            // ADD CLICKABLE LINK RIGHT HERE!
                            html += '<div style="margin: 15px 0; padding: 10px; background: #1a3a1a; border-left: 4px solid #0f0;">';
                            html += '<a href="#" onclick="analyzeEvent(' + index + '); return false;" style="color: #00ff00; text-decoration: none; font-weight: bold; font-size: 14px;">';
                            html += 'üîó Click here to discuss this event with RAG ‚Üí';
                            html += '</a>';
                            html += '<div style="color: #888; font-size: 11px; margin-top: 5px;">Opens Interactive RCA Assistant with this analysis loaded</div>';
                            html += '</div><br>';

                        });

                        html += '<div style="color: #666;">‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê</div>';
                        html += '</div>';

                        // Helper function to escape HTML
                        function escapeHtml(text) {
                            const div = document.createElement('div');
                            div.textContent = text;
                            return div.innerHTML.replace(/\n/g, '<br>');
                        }

                        logView.innerHTML = html;
                        logView.scrollTop = 0;
                    } else {
                        logView.textContent = '(no analysis history - try triggering anomalies first)';
                    }
                })
                .catch(error => {
                    document.getElementById('log-view').textContent = '‚ùå Failed: ' + error.message + '\nüí° Make sure Backend is running';
                });
        }

        function analyzeEvent(index) {
            if (!window.analysisHistoryItems || !window.analysisHistoryItems[index]) {
                alert('Load history first');
                return;
            }

            const item = window.analysisHistoryItems[index];
            const analysisId = item.id || item.timestamp;

            // Open the Interactive RCA Assistant page (frontend) with this analysis
            const frontendUrl = `http://127.0.0.1:5173/assistant?analysis_id=${analysisId}`;
            window.open(frontendUrl, '_blank');

            console.log('üîó Opening Interactive RCA for analysis:', analysisId);
        }

        function openAnalysisFolder() {
            // Call backend endpoint to open the analysis_history folder in Finder
            fetch('/api/open-analysis-folder', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('‚úÖ Opened analysis history folder');
                } else {
                    alert('‚ùå Failed to open folder: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('‚ùå Error opening folder: ' + error.message);
            });
        }


        // =========================================================================
        // System Snapshot Functions
        // =========================================================================

        function saveSystemSnapshot() {
            const name = prompt("Enter snapshot name:", "Snapshot " + new Date().toLocaleString());
            if (!name) return;

            const description = prompt("Description (optional):", "");

            fetch('http://127.0.0.1:8000/snapshot/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name: name, description: description})
            })
            .then(r => r.json())
            .then(data => {
                alert('‚úÖ Snapshot saved: ' + data.name);
                loadSnapshotList();
            })
            .catch(err => alert('‚ùå Failed to save: ' + err.message));
        }

        function loadSnapshotList() {
            fetch('http://127.0.0.1:8000/snapshot/list')
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('snapshot-list-container');

                    if (!data.items || data.items.length === 0) {
                        container.innerHTML = '<p style="color:#888;">No snapshots saved yet. Click "Save Snapshot" to create one.</p>';
                        return;
                    }

                    let html = '';
                    data.items.forEach(snap => {
                        const ts = new Date(snap.timestamp).toLocaleString();
                        html += `
                            <div style="background:#2a2a2a; padding:12px; margin:8px 0; border-radius:6px; border-left:4px solid #00ff00;">
                                <div style="font-weight:bold; color:#00ff00;">${snap.name}</div>
                                <div style="font-size:12px; color:#888;">üìÖ ${ts}</div>
                                ${snap.description ? `<div style="font-size:12px; color:#aaa; margin-top:4px;">${snap.description}</div>` : ''}
                                <div style="margin-top:8px;">
                                    <button class="btn btn-primary" onclick="restoreSnapshot(${snap.id})" style="font-size:12px; padding:6px 12px;">
                                        üìÇ Load This State
                                    </button>
                                    <button class="btn" onclick="deleteSnapshot(${snap.id})" style="font-size:12px; padding:6px 12px; background:#c44;">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            </div>
                        `;
                    });

                    container.innerHTML = html;
                })
                .catch(err => {
                    document.getElementById('snapshot-list-container').innerHTML =
                        '<p style="color:#f66;">‚ùå Failed to load snapshots. Make sure backend is running.</p>';
                });
        }

        function restoreSnapshot(id) {
            if (!confirm('Restore system to this snapshot?\n\nNote: Currently displays snapshot data. Full system restoration requires TEP bridge integration.')) {
                return;
            }

            fetch('http://127.0.0.1:8000/snapshot/restore', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: id})
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Snapshot loaded: ' + data.snapshot + '\n\nSnapshot data is available. Full system restore will be available after TEP bridge integration.');
                    console.log('Snapshot data:', data.data);
                } else {
                    alert('‚ùå Failed to restore snapshot');
                }
            })
            .catch(err => alert('‚ùå Error: ' + err.message));
        }

        function deleteSnapshot(id) {
            if (!confirm('Delete this snapshot? This cannot be undone.')) {
                return;
            }

            fetch(`http://127.0.0.1:8000/snapshot/delete/${id}`, {
                method: 'DELETE'
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Snapshot deleted');
                    loadSnapshotList();
                } else {
                    alert('‚ùå Failed to delete');
                }
            })
            .catch(err => alert('‚ùå Error: ' + err.message));
        }

        </script>

        <!-- Snapshot Details Modal -->
        <div id="snapshot-details-modal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.8); overflow:auto;">
            <div style="background:#1a1a1a; margin:5% auto; padding:30px; border:2px solid #00ff00; border-radius:10px; width:80%; max-width:1000px; color:#fff;">
                <span onclick="closeSnapshotDetailsModal()" style="float:right; font-size:28px; font-weight:bold; cursor:pointer; color:#00ff00;">&times;</span>
                <div id="snapshot-details-content"></div>
            </div>
        </div>

        <style>
            .snapshot-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 10px;
                font-size: 13px;
            }
            .snapshot-table th {
                background: #2a2a2a;
                color: #00ff00;
                padding: 8px;
                text-align: left;
                border-bottom: 2px solid #00ff00;
            }
            .snapshot-table td {
                padding: 8px;
                border-bottom: 1px solid #333;
            }
            .snapshot-table tr:hover {
                background: #2a2a2a;
            }
            .btn-small {
                padding: 4px 8px;
                font-size: 11px;
                margin-right: 4px;
                background: #333;
                color: #00ff00;
                border: 1px solid #00ff00;
                border-radius: 4px;
                cursor: pointer;
            }
            .btn-small:hover {
                background: #00ff00;
                color: #000;
            }
            .llm-result-box {
                background: #2a2a2a;
                padding: 15px;
                margin: 10px 0;
                border-left: 3px solid #00ff00;
                border-radius: 5px;
            }
            .llm-result-box h5 {
                color: #00ff00;
                margin-top: 0;
            }
            .enhancement-box {
                background: #2a2a2a;
                padding: 15px;
                margin: 10px 0;
                border-left: 3px solid #ffaa00;
                border-radius: 5px;
            }
        </style>

</body>
</html>
